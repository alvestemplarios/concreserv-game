<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>CONCRESERV COME-COME ‚Äî ALVES GAMES</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#00eaff">

  <!-- iPhone -->
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <style>
    :root {
      --border-color: #00eaff;
      --shadow-color: #00eaff;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #111, #000);
      font-family: "Segoe UI", Arial, Helvetica, sans-serif;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      user-select: none;
      touch-action: none;
    }

    h1 {
      margin-top: 15px;
      font-size: 28px;
      text-shadow: 0 0 10px var(--shadow-color), 0 0 20px #ff00ff;
    }

    #subTitle {
      font-size: 14px;
      opacity: 0.8;
      margin-bottom: 10px;
    }

    canvas {
      border: 5px solid var(--border-color);
      box-shadow: 0 0 25px var(--shadow-color), 0 0 35px #ff00ff;
      background: #000;
    }

    #menuOverlay {
      position: absolute;
      inset: 0;
      background: #000000dd;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 5;
    }

    .neon-btn {
      padding: 10px 22px;
      margin: 6px;
      border-radius: 25px;
      background: transparent;
      border: 2px solid var(--border-color);
      color: #fff;
      cursor: pointer;
      box-shadow: 0 0 15px var(--shadow-color);
      text-transform: uppercase;
    }

    #levelOverlay {
      position: absolute;
      inset: 0;
      background: #000000ee;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 4;
    }

    #truckFace {
      width: 150px;
      margin-bottom: 10px;
      box-shadow: 0 0 20px var(--shadow-color);
    }

    #hud {
      margin-top: 10px;
      display: flex;
      gap: 20px;
    }

    #footerBrand {
      margin-top: 15px;
      font-size: 14px;
      letter-spacing: 1px;
      text-shadow: 0 0 8px var(--shadow-color);
    }

    #joystickContainer {
      margin-top: 20px;
      display: none;
    }

    .jbtn {
      width: 60px;
      height: 60px;
      background: #111;
      border: 2px solid var(--border-color);
      box-shadow: 0 0 12px var(--shadow-color);
      margin: 5px;
      text-align: center;
      line-height: 60px;
      font-size: 26px;
      border-radius: 12px;
      cursor: pointer;
    }

    #joyGrid {
      display: grid;
      grid-template-columns: 60px 60px 60px;
    }

    @media (max-width: 700px) {
      canvas {
        transform: scale(0.85);
        transform-origin: top center;
      }
    }
  </style>
</head>

<body>

<h1>CONCRESERV COME-COME</h1>
<div id="subTitle">Vers√£o Web ‚Äî Caminh√£o Come Blocos de Concreto no labirinto neon</div>

<div style="position:relative;">
  <canvas id="game" width="608" height="480"></canvas>

  <div id="menuOverlay">
    <div style="font-size:26px;margin-bottom:10px;">üéÆ CONCRESERV RETRO NEON</div>
    <button class="neon-btn" id="startBtn">COME√áAR</button>
    <button class="neon-btn" id="modeBtn">REAL</button>
    <h3>Ranking</h3>
    <ol id="rankingList"></ol>
  </div>

  <div id="levelOverlay">
    <img src="img/truck_face.png" id="truckFace" alt="CONCRESERV">
    <div id="levelTitle">FASE CONCLU√çDA!</div>
    <div id="levelMsg"></div>
  </div>
</div>

<div id="hud">
  <div>Fase: <span id="levelValue">1</span></div>
  <div>Pontos: <span id="scoreValue">0</span></div>
  <div>Melhor: <span id="bestValue">0</span></div>
</div>

<div id="joystickContainer">
  <div id="joyGrid">
    <div></div><div class="jbtn" id="btnUp">‚¨ÜÔ∏è</div><div></div>
    <div class="jbtn" id="btnLeft">‚¨ÖÔ∏è</div><div></div><div class="jbtn" id="btnRight">‚û°Ô∏è</div>
    <div></div><div class="jbtn" id="btnDown">‚¨áÔ∏è</div><div></div>
  </div>
</div>

<div id="footerBrand">ALVES GAMES / CONCRESERV EDITION ‚Äî 2025</div>

<script>
/* ============================================================
   √ÅUDIO DO JOGO
   ============================================================ */
const sndEat     = new Audio("snd/eat.wav");
const sndDeath   = new Audio("snd/death.wav");
const sndVictory = new Audio("snd/victory.wav");
const sndMove    = new Audio("snd/move.wav");

function playSound(snd) {
  snd.currentTime = 0;
  snd.play().catch(()=>{});
}

/* ============================================================
   DOM / CANVAS
   ============================================================ */
const canvas = document.getElementById("game");
const ctx    = canvas.getContext("2d");

const menuOverlay = document.getElementById("menuOverlay");
const startBtn    = document.getElementById("startBtn");
const modeBtn     = document.getElementById("modeBtn");
const rankingList = document.getElementById("rankingList");

const levelOverlay = document.getElementById("levelOverlay");
const levelMsg     = document.getElementById("levelMsg");

const scoreSpan = document.getElementById("scoreValue");
const bestSpan  = document.getElementById("bestValue");
const levelSpan = document.getElementById("levelValue");

const joystickContainer = document.getElementById("joystickContainer");
const btnUp    = document.getElementById("btnUp");
const btnDown  = document.getElementById("btnDown");
const btnLeft  = document.getElementById("btnLeft");
const btnRight = document.getElementById("btnRight");

/* ============================================================
   ESTADO DO JOGO
   ============================================================ */
let gameState    = "menu";
let score        = 0;
let currentLevel = 1;
const tileSize   = 32;
let assetsLoaded = false;

/* ============================================================
   PALETAS DE CORES POR FASE
   ============================================================ */
const colorPalettes = [
  { wall: "#05071A", border: "#00eaff", shadow: "#00eaff", pellet: "#ffcc66" }, // 1‚Äì3
  { wall: "#1A051D", border: "#ff00ff", shadow: "#ff00ff", pellet: "#ff66cc" }, // 4‚Äì6
  { wall: "#1A1005", border: "#ffaa00", shadow: "#ffaa00", pellet: "#ffff66" }, // 7‚Äì9
  { wall: "#051A0F", border: "#00ff66", shadow: "#00ff66", pellet: "#66ffaa" }, // 10‚Äì12
  { wall: "#000000", border: "#ffffff", shadow: "#ff00ff", pellet: "#00eaff" }  // 13+
];
let currentPalette = colorPalettes[0];

/* ============================================================
   LABIRINTO
   ============================================================ */
const baseMaze = [
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1],
  [1,0,1,1,1,0,0,1,0,1,0,1,0,0,1,1,1,0,1],
  [1,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,1],
  [1,0,1,0,1,0,1,1,0,1,0,1,1,0,1,0,1,0,1],
  [1,0,1,0,0,0,0,1,0,0,0,1,0,0,0,0,1,0,1],
  [1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,1,1,1,1,0,1,1,0,1,1,0,1,1,1,1,0,1],
  [1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1],
  [1,0,1,0,1,0,1,1,0,1,0,1,1,0,1,0,1,0,1],
  [1,0,1,0,0,0,0,1,0,0,0,1,0,0,0,0,1,0,1],
  [1,0,1,1,1,0,0,1,0,1,0,1,0,0,1,1,1,0,1],
  [1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

let maze    = [];
let pellets = [];

const rows = baseMaze.length;
const cols = baseMaze[0].length;

/* ============================================================
   SPRITES
   ============================================================ */
const truckRealImg  = new Image();
const truckPixelImg = new Image();
const truckUpImg    = new Image();
const truckDownImg  = new Image();

truckRealImg.src  = "img/truck_real.png";
truckPixelImg.src = "img/truck_pixel.png";
truckUpImg.src    = "img/truck_up.png";
truckDownImg.src  = "img/truck_down.png";

const ghostRedImg    = new Image();
const ghostPinkImg   = new Image();
const ghostBlueImg   = new Image();
const ghostOrangeImg = new Image();

ghostRedImg.src    = "img/ghost_red.png";
ghostPinkImg.src   = "img/ghost_pink.png";
ghostBlueImg.src   = "img/ghost_blue.png";
ghostOrangeImg.src = "img/ghost_orange.png";

let spriteMode = "real";

function checkAssets() {
  const images = [
    truckRealImg, truckPixelImg, truckUpImg, truckDownImg,
    ghostRedImg, ghostPinkImg, ghostBlueImg, ghostOrangeImg
  ];
  const loaded = images.every(img => img.complete && img.naturalHeight !== 0);
  if (loaded) {
    assetsLoaded = true;
  } else {
    setTimeout(checkAssets, 100);
  }
}
checkAssets();

/* ============================================================
   PLAYER
   ============================================================ */
const truck = {
  x: 1, y: 1,
  dirX: 1, dirY: 0,
  nextDirX: 1, nextDirY: 0,
  offsetX: 0, offsetY: 0,
  speed: 0.06
};

/* ============================================================
   FANTASMAS
   ============================================================ */
const ghosts = [];

function createGhost(x, y, img, speed) {
  return { x, y, dirX: 0, dirY: 1, offsetX: 0, offsetY: 0, speed, img };
}

function resetGhosts(truckSpeed) {
  ghosts.length = 0;
  const base = truckSpeed;
  ghosts.push(createGhost( 9, 7, ghostRedImg,    base * 0.97));
  ghosts.push(createGhost(10, 7, ghostPinkImg,   base * 0.92));
  ghosts.push(createGhost( 8, 7, ghostBlueImg,   base * 0.87));
  ghosts.push(createGhost(11, 7, ghostOrangeImg, base * 0.82));
}

/* ============================================================
   RANKING
   ============================================================ */
const SCORE_KEY = "concreserv_scores";

function loadScores() {
  try { return JSON.parse(localStorage.getItem(SCORE_KEY)) || []; }
  catch { return []; }
}

function saveScore(s) {
  const arr = loadScores();
  arr.push(s);
  arr.sort((a, b) => b - a);
  localStorage.setItem(SCORE_KEY, JSON.stringify(arr.slice(0, 5)));
  updateRanking();
}

function updateRanking() {
  const arr = loadScores();
  rankingList.innerHTML = "";
  arr.forEach((v, i) => {
    const li = document.createElement("li");
    li.textContent = `${i + 1}¬∫ - ${v} pts`;
    rankingList.appendChild(li);
  });
  bestSpan.textContent = arr[0] || 0;
}
updateRanking();

/* ============================================================
   CONTROLES
   ============================================================ */
function setDirection(dx, dy) {
  truck.nextDirX = dx;
  truck.nextDirY = dy;
  playSound(sndMove);
}

window.addEventListener("keydown", (e) => {
  if (e.key === "ArrowUp")    setDirection(0, -1);
  if (e.key === "ArrowDown")  setDirection(0,  1);
  if (e.key === "ArrowLeft")  setDirection(-1, 0);
  if (e.key === "ArrowRight") setDirection(1,  0);
});

function addTouchHandler(btn, dx, dy) {
  btn.addEventListener("touchstart", (e) => { e.preventDefault(); setDirection(dx, dy); });
  btn.addEventListener("mousedown", () => setDirection(dx, dy));
}
addTouchHandler(btnUp, 0, -1);
addTouchHandler(btnDown, 0, 1);
addTouchHandler(btnLeft, -1, 0);
addTouchHandler(btnRight, 1, 0);

/* ============================================================
   START / MODE
   ============================================================ */
startBtn.addEventListener("click", () => {
  score        = 0;
  currentLevel = 1;
  levelSpan.textContent = currentLevel;
  scoreSpan.textContent = score;

  setupLevel();
  joystickContainer.style.display = "block";
  menuOverlay.style.display       = "none";
  gameState = "playing";
});

modeBtn.addEventListener("click", () => {
  spriteMode = (spriteMode === "real") ? "pixel" : "real";
  modeBtn.textContent = spriteMode.toUpperCase();
});

/* ============================================================
   N√çVEIS
   ============================================================ */
function setupLevel() {
  maze = baseMaze.map(row => row.slice());
  pellets = maze.map(row => row.map(c => c === 0));

  // Velocidade por fase
  const baseSpeed = 0.06;
  const speedIncrement = 0.008;
  const maxSpeed = 0.12;
  const levelSpeed = Math.min(baseSpeed + (currentLevel - 1) * speedIncrement, maxSpeed);
  truck.speed = levelSpeed;
  resetGhosts(levelSpeed);

  // Paleta por fase (muda a cada 3 fases)
  const paletteIndex = Math.min(Math.floor((currentLevel - 1) / 3), colorPalettes.length - 1);
  currentPalette = colorPalettes[paletteIndex];

  // Aplica estilo visual
  document.documentElement.style.setProperty('--border-color', currentPalette.border);
  document.documentElement.style.setProperty('--shadow-color', currentPalette.shadow);

  resetTruck();
}

function resetTruck() {
  truck.x = 1;
  truck.y = 1;
  truck.dirX = 1;
  truck.dirY = 0;
  truck.nextDirX = 1;
  truck.nextDirY = 0;
  truck.offsetX = 0;
  truck.offsetY = 0;
}

function levelCompleted() {
  playSound(sndVictory);
  saveScore(score);

  levelMsg.textContent = `Voc√™ concluiu a fase ${currentLevel}! Pontos: ${score}`;
  levelOverlay.style.display = "flex";

  currentLevel++;
  levelSpan.textContent = currentLevel;

  setTimeout(() => {
    levelOverlay.style.display = "none";
    setupLevel();
    gameState = "playing";
  }, 1500);
}

function gameOver() {
  playSound(sndDeath);
  saveScore(score);
  gameState = "menu";
  joystickContainer.style.display = "none";
  menuOverlay.style.display = "flex";
  startBtn.textContent  = "JOGAR NOVO";
}

/* ============================================================
   L√ìGICA DO JOGO
   ============================================================ */
function updateTruck() {
  if (truck.offsetX === 0 && truck.offsetY === 0) {
    const tx = truck.x + truck.nextDirX;
    const ty = truck.y + truck.nextDirY;
    if (maze[ty] && maze[ty][tx] === 0) {
      truck.dirX = truck.nextDirX;
      truck.dirY = truck.nextDirY;
    }
  }

  truck.offsetX += truck.dirX * truck.speed;
  truck.offsetY += truck.dirY * truck.speed;

  if (Math.abs(truck.offsetX) >= 1 || Math.abs(truck.offsetY) >= 1) {
    const nx = truck.x + Math.sign(truck.offsetX);
    const ny = truck.y + Math.sign(truck.offsetY);
    if (maze[ny] && maze[ny][nx] === 0) {
      truck.x = nx;
      truck.y = ny;
    }
    truck.offsetX = 0;
    truck.offsetY = 0;
  }

  if (pellets[truck.y][truck.x]) {
    pellets[truck.y][truck.x] = false;
    score += 10;
    scoreSpan.textContent = score;
    playSound(sndEat);
  }
}

function updateGhost(g) {
  if (g.offsetX === 0 && g.offsetY === 0) {
    const dirs = [{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}];
    let opts = dirs.filter(d => maze[g.y + d.y] && maze[g.y + d.y][g.x + d.x] === 0);
    if (opts.length > 0) {
      const c = opts[Math.floor(Math.random() * opts.length)];
      g.dirX = c.x;
      g.dirY = c.y;
    }
  }

  g.offsetX += g.dirX * g.speed;
  g.offsetY += g.dirY * g.speed;

  if (Math.abs(g.offsetX) >= 1 || Math.abs(g.offsetY) >= 1) {
    const nx = g.x + Math.sign(g.offsetX);
    const ny = g.y + Math.sign(g.offsetY);
    if (maze[ny] && maze[ny][nx] === 0) {
      g.x = nx;
      g.y = ny;
    }
    g.offsetX = 0;
    g.offsetY = 0;
  }
}

function checkCollisions() {
  const cx = (truck.x + truck.offsetX) * tileSize + 16;
  const cy = (truck.y + truck.offsetY) * tileSize + 16;

  for (const g of ghosts) {
    const gx = (g.x + g.offsetX) * tileSize + 16;
    const gy = (g.y + g.offsetY) * tileSize + 16;
    const dx = cx - gx;
    const dy = cy - gy;
    if (dx * dx + dy * dy < 484) {
      gameOver();
      return;
    }
  }

  if (!pellets.flat().some(v => v) && gameState === "playing") {
    levelCompleted();
  }
}

function drawMaze() {
  const pal = currentPalette;
  for (let y = 0; y < rows; y++) {
    for (let x = 0; x < cols; x++) {
      const px = x * tileSize;
      const py = y * tileSize;

      if (maze[y][x] === 1) {
        ctx.fillStyle = pal.wall;
        ctx.fillRect(px, py, tileSize, tileSize);
        ctx.strokeStyle = pal.border;
        ctx.lineWidth = 2;
        ctx.strokeRect(px + 3, py + 3, tileSize - 6, tileSize - 6);
      } else {
        ctx.fillStyle = "#000";
        ctx.fillRect(px, py, tileSize, tileSize);
        if (pellets[y][x]) {
          ctx.fillStyle = pal.pellet;
          ctx.fillRect(px + 12, py + 14, 8, 4);
        }
      }
    }
  }
}

function drawTruck() {
  const cx = (truck.x + truck.offsetX) * tileSize + 16;
  const cy = (truck.y + truck.offsetY) * tileSize + 16;
  const w = tileSize * 2;
  const h = tileSize * 1.1;

  let img;
  if (truck.dirY === -1) img = truckUpImg;
  else if (truck.dirY === 1) img = truckDownImg;
  else img = (spriteMode === "real") ? truckRealImg : truckPixelImg;

  ctx.save();
  ctx.translate(cx, cy);
  if (truck.dirY === 0 && truck.dirX === 1) ctx.scale(-1, 1);
  ctx.drawImage(img, -w / 2, -h / 2, w, h);
  ctx.restore();
}

function drawGhost(g) {
  const cx = (g.x + g.offsetX) * tileSize + 16;
  const cy = (g.y + g.offsetY) * tileSize + 16;
  const w = tileSize * 1.6;
  const h = tileSize * 1.1;
  ctx.drawImage(g.img, cx - w / 2, cy - h / 2, w, h);
}

function draw() {
  if (!assetsLoaded) return;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawMaze();
  drawTruck();
  ghosts.forEach(drawGhost);
}

function loop() {
  if (gameState === "playing") {
    updateTruck();
    ghosts.forEach(updateGhost);
    checkCollisions();
  }
  draw();
  requestAnimationFrame(loop);
}

setupLevel();
loop();
</script>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js')
    .then(() => console.log("Service Worker registrado!"))
    .catch((err) => console.log("Erro no SW:", err));
}
</script>

</body>
</html>